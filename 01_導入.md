# 実践的なテスト駆動開発(TDD)活用 WEBアプリケーションAPI開発TypeScriptハンズオン

## はじめに

このハンズオンでは、以下の要素を組み合わせた実践的なAPI開発の方法を学びます：

- TypeScriptによる型安全な開発
- Jestを使用したテストの書き方
- Express.jsでのAPI実装
- テスト駆動開発（TDD）の実践的なアプローチ

## 第1章 TDDの基礎と実践

:::message
TDD（テスト駆動開発）の知識がゼロの方でも始められるように、基礎から丁寧に解説しています。
:::

TDDについての詳しい基礎知識が必要な方は、以下の記事もご参照ください：
https://zenn.dev/nezumizuki/articles/fa821accc95050

このハンズオンでは、TodoリストAPIの開発を通して、実践的な開発シナリオでTDDを学んでいきます。

### 1.1 TDDの三原則と実践

TDDには3つの重要な原則があります。これらの原則に従うことで、より信頼性の高いコードを効率的に開発できます。

#### 1. 先にテストを書く（Red）

テストを先に書くことで、実装の前に要件を明確にし、テスト可能な設計を導き出します。

```typescript
// ✅ 正しいアプローチ：先にテストを書く
test('createTodo creates a new todo', async () => {
  const todo = await todoRepository.create({ title: 'Test Todo' });
  expect(todo.id).toBeDefined();
  expect(todo.title).toBe('Test Todo');
  expect(todo.completed).toBe(false);
});

// ❌ 間違ったアプローチ：実装を先に書いて後からテストを追加
// これではテストが実装に引きずられてしまい、本来確認すべき要件を見落とす可能性があります
```

**解説**：
- テストでは、作成されるTodoの期待される状態を明確に定義
- 非同期処理（async/await）の適切な使用
- TypeScriptの型システムを活用した安全な実装

#### 2. テストが失敗することを確認（Red）

新しく書いたテストは、必ず最初は失敗する状態になります：

```bash
# テスト実行結果の例
FAIL src/repositories/__tests__/todo.repository.test.ts
  ● TodoRepository › createTodo › creates a new todo
    TypeError: Cannot read properties of undefined (reading 'create')
```

**解説**：
- この段階でのエラーは正常で必要なプロセス
- エラーメッセージから、何が足りないのかが明確に分かる
- これにより、必要最小限の実装範囲が明確になる

#### 3. 最小限の実装でテストを通す（Green）

テストを通すための最小限の実装を行います：

```typescript
export class TodoRepository {
  async create(data: CreateTodoDTO): Promise<Todo> {
    // 最小限の実装
    return {
      id: '1',  // とりあえずハードコード
      ...data,
      completed: false,
      createdAt: new Date(),
      updatedAt: new Date()
    };
  }
}
```

**解説**：
- まずは最もシンプルな実装でテストを通す
- この段階では、IDの生成ロジックなど本来必要な実装も省略
- TypeScriptの型システムにより、戻り値の型安全性を確保

### 1.2 実践的なTDDのポイント

実際の開発では、以下のポイントを意識することで、より効果的にTDDを活用できます。

#### 1. テストの粒度を適切に保つ

```typescript
// ✅ 適切な粒度：一つのテストで一つの機能を検証
test('trims whitespace from title when creating todo', async () => {
  const todo = await todoRepository.create({ title: '  Test Todo  ' });
  expect(todo.title).toBe('Test Todo');
});

// ❌ 粒度が大きすぎる：複数の機能を一つのテストで検証
test('creates todo with various validations', async () => {
  const todo1 = await todoRepository.create({ title: '  Test1  ' });
  expect(todo1.title).toBe('Test1');
  
  const todo2 = await todoRepository.create({ title: '' });
  expect(todo2).toThrow();
  
  const todo3 = await todoRepository.create({ title: 'Test3', completed: true });
  expect(todo3.completed).toBe(true);
});
```

**解説**：
- 一つのテストでは一つの機能に焦点を当てる
- エラーが発生した際に、原因の特定が容易になる
- テストの意図が明確になり、メンテナンスが容易になる

#### 2. 境界値のテストを重視

```typescript
describe('TodoRepository', () => {
  describe('create', () => {
    test('throws error for empty title', async () => {
      await expect(
        todoRepository.create({ title: '' })
      ).rejects.toThrow('Title cannot be empty');
    });

    test('throws error for title with only whitespace', async () => {
      await expect(
        todoRepository.create({ title: '   ' })
      ).rejects.toThrow('Title cannot be empty');
    });

    test('accepts title with maximum length', async () => {
      const maxLengthTitle = 'a'.repeat(100);
      const todo = await todoRepository.create({ title: maxLengthTitle });
      expect(todo.title).toBe(maxLengthTitle);
    });
  });
});
```

**解説**：
- 空文字、最大長、特殊文字などの境界値をテスト
- エラーケースの適切な処理を確認
- TypeScriptの型システムと組み合わせた堅牢な実装

#### 3. テストの意図を明確に記述

```typescript
// ✅ 良い例：テストの意図が明確
describe('TodoRepository', () => {
  describe('toggleComplete', () => {
    test('marks incomplete todo as completed', async () => {
      // テストの準備
      const todo = await todoRepository.create({ title: 'Test' });
      expect(todo.completed).toBe(false);

      // テスト対象の操作を実行
      const updated = await todoRepository.toggleComplete(todo.id);

      // 結果の検証
      expect(updated.completed).toBe(true);
    });

    test('marks completed todo as incomplete', async () => {
      // テストの準備
      const todo = await todoRepository.create({ 
        title: 'Test',
        completed: true
      });

      // テスト対象の操作を実行
      const updated = await todoRepository.toggleComplete(todo.id);

      // 結果の検証
      expect(updated.completed).toBe(false);
    });
  });
});
```

**解説**：
- テストケース名が機能や期待する動作を明確に説明
- Arrange-Act-Assert パターンに従った構造的なテスト記述
- コメントを使用して、テストの各段階を明確に区分

### 1.3 このハンズオンの進め方

以降の章では、実際のTodoリストAPIを開発しながら、以下の要素を学んでいきます：

1. TypeScriptによる型定義と型安全性の確保
2. Jestを使用した効果的なテストの書き方
3. Express.jsでのRESTful API実装
4. レイヤードアーキテクチャの実践
   - リポジトリレイヤー（データアクセス）
   - サービスレイヤー（ビジネスロジック）
   - コントローラーレイヤー（API）

それでは次章から、実際のコードを書きながらTDDを実践していきましょう。
