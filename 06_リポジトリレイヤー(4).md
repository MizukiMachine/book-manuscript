## 7. 更新機能の実装

Todoの更新機能を実装していきます。以下のテストから始めましょう

```typescript
// src/repositories/todo.repository.test.ts
// 既存のテストコードの下に追加

    describe('update', () => {
        test('updates todo fields', async () => {
            // テスト用のTodoを作成
            const todo = await repository.create({
                title: 'Original Title',
                description: 'Original Description'
            });

            // 更新用のDTOを作成
            const updateDto: UpdateTodoDTO = {
                title: 'Updated Title',
                description: 'Updated Description',
                completed: true
            };

            // Todoを更新
            const updated = await repository.update(todo.id, updateDto);

            // 更新結果の検証
            expect(updated.title).toBe(updateDto.title);
            expect(updated.description).toBe(updateDto.description);
            expect(updated.completed).toBe(true);
            expect(updated.updatedAt).not.toEqual(todo.updatedAt);
        });

        test('throws error when todo does not exist', async () => {
            const updateDto: UpdateTodoDTO = {
                title: 'Updated Title'
            };

            await expect(
                repository.update('non-existent-id', updateDto)
            ).rejects.toThrow('Todo not found');
        });

        test('maintains unchanged fields', async () => {
            // 元のTodoを作成
            const todo = await repository.create({
                title: 'Original Title',
                description: 'Original Description'
            });

            // タイトルのみを更新
            const updated = await repository.update(todo.id, {
                title: 'Updated Title'
            });

            // 説明文が維持されていることを確認
            expect(updated.title).toBe('Updated Title');
            expect(updated.description).toBe('Original Description');
        });
    });
```

テスト結果
```
FAIL  src/repositories/todo.repository.test.ts
  ● TodoRepository › update › updates todo fields
    TypeError: repository.update is not a function
```

更新機能を実装しましょう

```typescript
// src/repositories/todo.repository.ts
import { Todo, CreateTodoDTO, UpdateTodoDTO } from '../types';

export class TodoRepository {
    // 既存のコード...

    async update(id: string, dto: UpdateTodoDTO): Promise<Todo> {
        // 更新対象のTodoを検索
        const todo = await this.findById(id);
        if (!todo) {
            throw new Error('Todo not found');
        }

        // 更新するフィールドを設定
        const updatedTodo: Todo = {
            ...todo,                              // 既存のフィールドを展開
            title: dto.title?.trim() ?? todo.title, // タイトルが指定されていれば更新
            description: dto.description?.trim() ?? todo.description, // 説明も同様
            completed: dto.completed ?? todo.completed, // 完了状態も同様
            updatedAt: new Date()                // 更新日時は必ず新しく
        };

        this.todos.set(id, updatedTodo);
        return updatedTodo;
    }
}
```

```typescript
// src/repositories/todo.repository.test.ts
import { CreateTodoDTO, UpdateTodoDTO } from '../types';
      // 既存のコード...
```

実装のポイント
- `??`演算子を使用して、更新されないフィールドは元の値を維持
- タイトルと説明文は更新時も`trim()`を適用
- 更新日時は必ず現在時刻に更新

テスト結果
```
PASS  src/repositories/todo.repository.test.ts
  TodoRepository
    create
      ✓ creates a new todo with required fields (2ms)
    findById
      ✓ returns todo when exists (1ms)
      ✓ returns null when todo does not exist (1ms)
    findAll
      ✓ returns empty array when no todos exist (1ms)
      ✓ returns all todos (1ms)
    update
      ✓ updates todo fields (1ms)
      ✓ throws error when todo does not exist (1ms)
      ✓ maintains unchanged fields (1ms)
```
