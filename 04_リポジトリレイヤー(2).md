
## 3. バリデーション機能の追加

TodoRepositoryに入力値の検証機能を追加していきます。まずはテストから書いていきましょう

```typescript
// src/repositories/todo.repository.test.ts
describe('TodoRepository', () => {
    let repository: TodoRepository;

    beforeEach(() => {
        repository = new TodoRepository();
    });

    describe('create', () => {
        // 既存のテストは維持したまま、バリデーション用のテストを追加
        test('throws error for empty title', async () => {
            const dto: CreateTodoDTO = {
                title: ''
            };

            await expect(repository.create(dto))
                .rejects
                .toThrow('Title cannot be empty');
        });

        test('throws error for title with only whitespace', async () => {
            const dto: CreateTodoDTO = {
                title: '   '
            };

            await expect(repository.create(dto))
                .rejects
                .toThrow('Title cannot be empty');
        });

        test('trims whitespace from title', async () => {
            const dto: CreateTodoDTO = {
                title: '  Test Todo  '
            };

            const todo = await repository.create(dto);
            expect(todo.title).toBe('Test Todo');
        });
    });
});
```

テストを実行してみましょう：

```bash
npm test
```

実行結果：
```
FAIL  src/repositories/todo.repository.test.ts
  TodoRepository
    create
      ✓ creates a new todo with required fields (3ms)
      ✕ throws error for empty title (4ms)
      ✕ throws error for title with only whitespace (1ms)
      ✕ trims whitespace from title (1ms)

  ● TodoRepository › create › throws error for empty title
    expect(received).toThrow()
    Received function did not throw

  ● TodoRepository › create › throws error for title with only whitespace
    expect(received).toThrow()
    Received function did not throw
    
  ● TodoRepository › create › trims whitespace from title
    expect(received).toBe(expected)
    Expected: "Test Todo"
    Received: "  Test Todo  "
```

テストが失敗したので、これらのテストを通すように実装を修正します：

```typescript
// src/repositories/todo.repository.ts
import { Todo, CreateTodoDTO } from '../types';
import { v4 as uuidv4 } from 'uuid';

export class TodoRepository {
    private todos: Map<string, Todo> = new Map();

    async create(dto: CreateTodoDTO): Promise<Todo> {
        // バリデーションを追加
        const title = dto.title.trim();
        if (!title) {
            throw new Error('Title cannot be empty');
        }

        const todo: Todo = {
            id: uuidv4(),
            title: title,  // トリム済みのタイトルを使用
            description: dto.description?.trim(),  // 説明文もトリム
            completed: false,
            createdAt: new Date(),
            updatedAt: new Date()
        };

        this.todos.set(todo.id, todo);
        return todo;
    }
}
```

実装のポイント：
- `trim()`を使用して前後の空白を除去
- 空文字列や空白のみの場合はエラーをスロー
- 説明文もある場合は同様にトリム処理を行う

再度テストを実行してみましょう：

```bash
npm test
```

実行結果：
```
PASS  src/repositories/todo.repository.test.ts
  TodoRepository
    create
      ✓ creates a new todo with required fields (3ms)
      ✓ throws error for empty title (1ms)
      ✓ throws error for title with only whitespace (1ms)
      ✓ trims whitespace from title (1ms)
```

全てのテストが通りました！次は検索機能の実装に進みましょうか？
